<?xml version="1.0" encoding="UTF-8"?>
<configuration>
    <!--
        Production environment configuration.
        - Logs to rolling file
        - JSON format (compact, no pretty printing)
        - INFO level logging
        - Includes MDC for correlation IDs
        - Log rotation: 100MB per file, 30 days retention, 10GB total cap
    -->

    <!-- Log directory for production file logging -->
    <variable name="LOG_DIR" value="${LOG_DIR:-./logs}" />

    <!-- Application name for log context -->
    <variable name="APP_NAME" value="java-web-server" />

    <!-- ========================================== -->
    <!-- Rolling File Appender - JSON format       -->
    <!-- ========================================== -->
    <appender name="FILE" class="ch.qos.logback.core.rolling.RollingFileAppender">
        <file>${LOG_DIR}/application.log</file>

        <!-- Rolling policy: size and time based -->
        <rollingPolicy class="ch.qos.logback.core.rolling.SizeAndTimeBasedRollingPolicy">
            <!-- Daily rollover with date pattern -->
            <fileNamePattern>${LOG_DIR}/application.%d{yyyy-MM-dd}.%i.log</fileNamePattern>

            <!-- Maximum file size before rollover -->
            <maxFileSize>100MB</maxFileSize>

            <!-- Keep 30 days of history -->
            <maxHistory>30</maxHistory>

            <!-- Total size cap for all log files -->
            <totalSizeCap>10GB</totalSizeCap>
        </rollingPolicy>

        <encoder class="net.logstash.logback.encoder.LogstashEncoder">
            <!-- Add custom fields -->
            <customFields>{"app":"${APP_NAME}","env":"production"}</customFields>

            <!-- Use ISO 8601 timestamp format -->
            <timestampPattern>yyyy-MM-dd'T'HH:mm:ss.SSSXXX</timestampPattern>

            <!-- Include MDC for correlation IDs -->
            <includeMdc>true</includeMdc>

            <!-- Include context name -->
            <includeContext>true</includeContext>

            <!-- Disable caller data in production for performance -->
            <includeCallerData>false</includeCallerData>

            <!-- No pretty printing in production (compact JSON) -->
        </encoder>
    </appender>

    <!-- ========================================== -->
    <!-- Root Logger: INFO level                   -->
    <!-- ========================================== -->
    <root level="INFO">
        <appender-ref ref="FILE" />
    </root>

    <!-- ========================================== -->
    <!-- Logger configurations                     -->
    <!-- ========================================== -->

    <!-- Reduce noise from common libraries -->
    <logger name="org.eclipse.jetty" level="WARN"/>
    <logger name="io.netty" level="WARN"/>

    <!-- Application logger: INFO level -->
    <logger name="ch.alejandrogarciahub.webserver" level="INFO" additivity="false">
        <appender-ref ref="FILE" />
    </logger>

</configuration>